<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Fixed USDZ AR Viewer</title>
  <script src="https://unpkg.com/@google/model-viewer@2.1.1/dist/model-viewer.min.js"></script>
  <script src="https://unpkg.com/@google/model-viewer@2.1.1/dist/model-viewer-legacy.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #000;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      height: 100vh;
      width: 100vw;
    }
    
    #container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    #video-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1;
    }
    
    model-viewer {
      width: 100%;
      height: 100%;
      --poster-color: transparent;
      position: absolute;
      top: 0;
      left: 0;
    }
    
    #ar-button-container {
      position: fixed;
      bottom: 20px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      z-index: 10;
      padding: 0 20px;
      box-sizing: border-box;
    }
    
    #ar-button {
      background: linear-gradient(to bottom, #52A7F9, #2E6EE1);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      border: none;
      font-size: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      min-width: 160px;
      text-align: center;
      transform: translateZ(0); /* Fix for Safari rendering */
    }
    
    #status {
      position: fixed;
      top: env(safe-area-inset-top, 20px);
      left: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 13px;
      z-index: 10;
      max-width: calc(100% - 40px);
      word-break: break-word;
    }
    
    #unsupported {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      color: white;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 20px;
      text-align: center;
    }
    
    #unsupported h2 {
      margin-bottom: 15px;
      font-size: 20px;
    }
    
    #unsupported p {
      margin-bottom: 12px;
      font-size: 15px;
      max-width: 80%;
    }
    
    .lds-dual-ring {
      display: inline-block;
      width: 40px;
      height: 40px;
      margin-bottom: 15px;
    }
    .lds-dual-ring:after {
      content: " ";
      display: block;
      width: 32px;
      height: 32px;
      margin: 4px;
      border-radius: 50%;
      border: 3px solid #fff;
      border-color: #fff transparent #fff transparent;
      animation: lds-dual-ring 1.2s linear infinite;
    }
    @keyframes lds-dual-ring {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Safe area adjustments for notch devices */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      #ar-button-container {
        bottom: calc(20px + env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Video Background -->
    <video id="video-bg" autoplay loop muted playsinline webkit-playsinline>
      <source src="Tiger.mp4" type="video/mp4">
    </video>
    
    <!-- Model Viewer with legacy support -->
    <model-viewer
      id="model-viewer"
      src="all.glb"
      ar
      ar-modes="quick-look scene-viewer webxr"
      camera-controls
      environment-image="neutral"
      shadow-intensity="1"
      exposure="0.8"
      camera-orbit="0deg 75deg 105%"
      alt="3D Model"
      ios-src="all.usdz"
      xr-environment
      quick-look-browsers="safari chrome"
    ></model-viewer>
    
    <!-- AR Button Container -->
    <div id="ar-button-container">
      <button id="ar-button">View in AR</button>
    </div>
    
    <!-- Status Message -->
    <div id="status">Initializing AR...</div>
    
    <!-- Unsupported Message with loading spinner -->
    <div id="unsupported">
      <div class="lds-dual-ring"></div>
      <h2>Loading AR Experience</h2>
      <p id="unsupported-message">Checking your device capabilities...</p>
    </div>
  </div>

  <script>
    (function() {
      // DOM elements
      const modelViewer = document.getElementById('model-viewer');
      const arButton = document.getElementById('ar-button');
      const statusDiv = document.getElementById('status');
      const unsupportedDiv = document.getElementById('unsupported');
      const unsupportedMessage = document.getElementById('unsupported-message');
      const videoBg = document.getElementById('video-bg');
      
      // Configuration
      const config = {
        minIOSVersion: 11.0,
        minAndroidVersion: 8.0,
        testMode: false
      };
      
      // State
      let arSupported = false;
      let isIOS = false;
      let isAndroid = false;
      let osVersion = 0;
      
      // Initialize
      function init() {
        detectPlatform();
        checkARSupport().then(supported => {
          if (supported) {
            setupAR();
          } else {
            showUnsupported("Your device doesn't support AR features");
          }
        }).catch(error => {
          showUnsupported("Error checking AR support: " + error.message);
        });
      }
      
      // Detect platform and version
      function detectPlatform() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        
        // iOS detection
        if (/iPad|iPhone|iPod/.test(userAgent)) {
          isIOS = true;
          const match = userAgent.match(/OS (\d+)_(\d+)_?(\d+)?/);
          osVersion = match ? parseFloat(match[1] + '.' + (match[2] || '0')) : 0;
        }
        // Android detection
        else if (/android/i.test(userAgent)) {
          isAndroid = true;
          const match = userAgent.match(/Android\s([0-9\.]+)/);
          osVersion = match ? parseFloat(match[1]) : 0;
        }
        
        if (config.testMode) {
          console.log(`Detected: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Other'}, Version: ${osVersion}`);
        }
      }
      
      // Check AR support with platform-specific checks
      function checkARSupport() {
        return new Promise((resolve) => {
          // iOS Quick Look (works on older iOS)
          if (isIOS && osVersion >= config.minIOSVersion) {
            statusDiv.textContent = "iOS device detected";
            
            // Check for Quick Look support
            const a = document.createElement('a');
            if (a.relList && a.relList.supports && a.relList.supports('ar')) {
              return resolve(true);
            }
            
            // Fallback check for older iOS
            if (osVersion >= 11.0) {
              return resolve(true);
            }
          }
          
          // Android Scene Viewer/WebXR
          if (isAndroid && osVersion >= config.minAndroidVersion) {
            statusDiv.textContent = "Android device detected";
            
            // Check for WebXR or Scene Viewer
            if (modelViewer.canActivateAR) {
              return resolve(true);
            }
            
            // Check for Scene Viewer intent
            const link = document.createElement('a');
            link.href = 'https://arvr.google.com/scene-viewer/1.0';
            if (link.protocol === 'intent:') {
              return resolve(true);
            }
          }
          
          // WebXR fallback
          if ('xr' in navigator) {
            return navigator.xr.isSessionSupported('immersive-ar')
              .then(supported => resolve(supported))
              .catch(() => resolve(false));
          }
          
          // No AR support detected
          resolve(false);
        });
      }
      
      // Setup AR functionality
      function setupAR() {
        unsupportedDiv.style.display = 'none';
        statusDiv.textContent = "AR ready - tap View in AR";
        
        // Handle AR button click
        arButton.addEventListener('click', function() {
          launchAR();
        });
        
        // Handle AR session events
        modelViewer.addEventListener('ar-status', function(event) {
          if (event.detail.status === 'session-started') {
            videoBg.pause();
            statusDiv.textContent = "AR session started";
          } else if (event.detail.status === 'not-presenting') {
            videoBg.play();
            statusDiv.textContent = "AR session ended";
          }
        });
      }
      
      // Launch AR experience
      function launchAR() {
        statusDiv.textContent = "Launching AR...";
        videoBg.pause();
        arButton.disabled = true;
        
        // For iOS devices
        if (isIOS) {
          // Ensure the USDZ file is properly referenced
          const usdzUrl = new URL('all.usdz', window.location.href).href;
          modelViewer.setAttribute('ios-src', usdzUrl);
          
          // Add timeout in case AR fails to launch
          const timeout = setTimeout(() => {
            statusDiv.textContent = "AR launch timed out - trying alternative method";
            videoBg.play();
            arButton.disabled = false;
            
            // Fallback to direct USDZ link for older iOS
            if (osVersion < 13.0) {
              window.location.href = usdzUrl;
            }
          }, 3000);
          
          // Clear timeout if AR launches successfully
          const statusHandler = function(event) {
            if (event.detail.status === 'session-started') {
              clearTimeout(timeout);
              modelViewer.removeEventListener('ar-status', statusHandler);
            }
          };
          modelViewer.addEventListener('ar-status', statusHandler);
          
          // Trigger AR
          modelViewer.activateAR().catch(error => {
            clearTimeout(timeout);
            statusDiv.textContent = "AR error: " + error.message;
            videoBg.play();
            arButton.disabled = false;
          });
        }
        // For Android devices
        else if (isAndroid) {
          modelViewer.activateAR().catch(error => {
            statusDiv.textContent = "AR error: " + error.message;
            videoBg.play();
            arButton.disabled = false;
            
            // Fallback to Scene Viewer
            setTimeout(() => {
              const sceneViewerUrl = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(window.location.origin + '/all.glb')}&mode=ar_only#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;end;`;
              window.location.href = sceneViewerUrl;
            }, 500);
          });
        }
      }
      
      // Show unsupported message
      function showUnsupported(message) {
        unsupportedDiv.style.display = 'flex';
        unsupportedMessage.textContent = message;
        document.getElementById('ar-button-container').style.display = 'none';
        statusDiv.textContent = message;
        
        if (config.testMode) {
          console.log("Unsupported: " + message);
        }
      }
      
      // Start the application when DOM is fully loaded
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(init, 1);
      } else {
        document.addEventListener('DOMContentLoaded', init);
      }
    })();
  </script>
</body>
</html>
